<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Clonk controller</title>
  <script src="https://unpkg.com/mqtt@3.0.0/dist/mqtt.min.js"></script>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    tr:hover {background-color: #D6EEEE;}
  </style>
</head>
<body>
  <h1>Clonk controller</h1>
  <p id="token_input">
    <label>
      Insert access token here:<br>
      <input type="text" id="token" placeholder="64-char string" size="80">
    </label>
      <button onclick="connect()">Connect</button>
  </p>
  <p>
    <table id="data_table">

    </table>
  </p>
  <p>
    <button onclick="send_reset(1)">Reset</button>
    <button style="background-color: #f44336" onclick="send_reset(2)">Factory reset</button>
  </p>

  <script>
    var client;
    var waiting = -1;
    function connect(){
      console.log("Connecting...")
      var token = document.getElementById('token').value.trim();
      var clientID =  Math.floor(Math.random() * 9000000 + 100000);

      client = mqtt.connect('wss://mqtt.flespi.io:443', {
        clientId: clientID,
        username: 'FlespiToken ' + token,
        protocolVersion: 5,
        clean: true,
      });
      client.on('error', function (error_message) {
        client.end(true);
        document.getElementById('token_input').innerHTML =
        `<p>
          <label>
            Insert access token here:<br>
            <input type="text" id="token" placeholder="64-char string" size="80">
          </label>
            <button onclick="connect()">Connect</button>
        </p>`
        console.log(error_message);
      })
      client.subscribe(subscribe_topic);
      client.subscribe(publish_topic);
      client.on('message', function (topic, message) {
        message = message.toString('utf8').split(' ');

        console.log(topic);
        console.log(message);

        if ( topic == subscribe_topic ){
          if ( message[1] == 'OK'){
            if (message.length == registers + 2 ){
              update_table(message, data_items);
            } else if ( waiting != -1 ){
              update_row(message, data_items);
            }
          }
        }
      })
      console.log("Connected!")
      request_all_data();
      document.getElementById("token_input").innerHTML = "Connected!";
    }

    const registers = 75;
    const subscribe_topic = "response";
    const publish_topic = "request";
    const data_items = [
      { name: "Hash",           unit: " ",      index: 1,  bytes: 1, type:"num", readable: true, writeable: false },
      { name: "Resets",         unit: " ",      index: 2,  bytes: 1, type:"num", readable: true, writeable: false },
      { name: "Tank volume",    unit: "Litres", index: 7,  bytes: 2, type:"num", readable: true, writeable: false },
      { name: "Dam volume",     unit: "Litres", index: 9,  bytes: 2, type:"num", readable: true, writeable: false },
      { name: "Tank Flow Rate", unit: "L/hr",   index: 11,  bytes: 2, type:"num", readable: true, writeable: false },
      { name: "Dam Flow Rate",  unit: "L/hr",   index: 13,  bytes: 2, type:"num", readable: true, writeable: false },
      { name: "High flow",      unit: " ",      index: 14,  bytes: 1, type:"bin", readable: true, writeable: false },
      { name: "Low flow",       unit: " ",      index: 15,  bytes: 1, type:"bin", readable: true, writeable: false },
      { name: "Allocated",      unit: " ",      index: 16,  bytes: 1, type:"bin", readable: true, writeable: false },
      { name: "Tank state",     unit: " ",      index: 17,  bytes: 1, type:"bin", readable: true, writeable: false },
      { name: "Dam state",      unit: " ",      index: 18,  bytes: 1, type:"bin", readable: true, writeable: false },
      { name: "Winter",         unit: " ",      index: 19,  bytes: 1, type:"num", readable: true, writeable: false },
      { name: "RTC flags",      unit: " ",      index: 20,  bytes: 1, type:"num", readable: true, writeable: false },
      { name: "Temperature",    unit: "deg C",  index: 21,  bytes: 1, type:"num", readable: true, writeable: false },
      { name: "Manual request", unit: " ",      index: 88,  bytes: 1, type:"bin", readable: false, writeable: true },
      { name: "Set all volume", unit: " ",      index: 89,  bytes: 1, type:"num", readable: false, writeable: true },
      { name: "Set all time",   unit: " ",      index: 90,  bytes: 1, type:"num", readable: false, writeable: true },
      { name: "Master valve",   unit: " ",      index: 92,  bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Modbus address", unit: " ",      index: 94,  bytes: 1, type:"num", readable: true, writeable: false },
      { name: "Modbus baud",    unit: " ",      index: 95,  bytes: 1, type:"num", readable: true, writeable: false },
      { name: "Winter Start",   unit: "Date",   index: 97,  bytes: 2, type:"time", readable: true, writeable: true },
      { name: "Winter Stop",    unit: "Date",   index: 99,  bytes: 2, type:"time", readable: true, writeable: true },
      { name: "Dam start",      unit: "Min",    index: 100, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Dam stop",       unit: "Min",    index: 101, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Tank Vol/Pulse", unit: "L/pulse",index: 102, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Dam Vol/Pulse",  unit: "L/pulse",index: 103, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Tank prime time",unit: "seconds",index: 104, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Dam prime time", unit: "seconds",index: 105, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Tank no-flow",   unit: "L/s",    index: 106, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Dam no-flow",    unit: "L/s",    index: 107, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Tank norm flow", unit: "L/s",    index: 108, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Dam norm flow",  unit: "L/s",    index: 109, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Dam vol alloc",  unit: "L",      index: 111, bytes: 2, type:"num", readable: true, writeable: true },
      { name: "Dam use volume", unit: " ",      index: 112, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Control flags",  unit: " ",      index: 113, bytes: 1, type:"bin", readable: true, writeable: true },
      { name: "Control mode",   unit: " ",      index: 114, bytes: 1, type:"num", readable: true, writeable: true },
      { name: "Valve 1 vol",    unit: "Litres", index: 115, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 2 vol",    unit: "Litres", index: 116, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 3 vol",    unit: "Litres", index: 117, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 4 vol",    unit: "Litres", index: 118, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 5 vol",    unit: "Litres", index: 119, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 6 vol",    unit: "Litres", index: 120, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 7 vol",    unit: "Litres", index: 121, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 8 vol",    unit: "Litres", index: 122, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 9 vol",    unit: "Litres", index: 123, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 10 vol",   unit: "Litres", index: 124, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 11 vol",   unit: "Litres", index: 125, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 12 vol",   unit: "Litres", index: 126, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 13 vol",   unit: "Litres", index: 127, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 1 time",   unit: "Seconds",index: 128, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 2 time",   unit: "Seconds",index: 129, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 3 time",   unit: "Seconds",index: 130, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 4 time",   unit: "Seconds",index: 131, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 5 time",   unit: "Seconds",index: 132, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 6 time",   unit: "Seconds",index: 133, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 7 time",   unit: "Seconds",index: 134, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 8 time",   unit: "Seconds",index: 135, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 9 time",   unit: "Seconds",index: 136, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 10 time",  unit: "Seconds",index: 137, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 11 time",  unit: "Seconds",index: 138, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 12 time",  unit: "Seconds",index: 139, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Valve 13 time",  unit: "Seconds",index: 140, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Num valves",     unit: " ",      index: 141, bytes: 1, type:"num",  readable: true, writeable: true },
      { name: "Time",           unit: "Date",   index: 145, bytes: 2, type:"time", readable: true, writeable: true }
    ];

    const table = document.getElementById("data_table");
    let header = table.createTHead();
    let row = header.insertRow();
    let cell = row.insertCell(0);
    cell = row.insertCell(1).innerHTML = "<b>Current data</b>";
    cell = row.insertCell(2).innerHTML = "<b>Units</b>";
    cell = row.insertCell(3);
    cell = row.insertCell(4).innerHTML = "<b>New data</b>";
    cell = row.insertCell(5);
    for (let i = 0; i < data_items.length; i++) {
      item = data_items[i];
      let row = table.insertRow();
      row.id = i;
      let name = row.insertCell(0);
      name.innerHTML = item.name;
      row.insertCell(1);
      let unit = row.insertCell(2);
      unit.innerHTML = item.unit;
      let button = row.insertCell(3);
      if ( item.readable ){
        button.innerHTML = "<button onclick=request_row_data()>Request this</button>";
      }
      if ( item.writeable ){
        row.insertCell(4).innerHTML = "<input type='text' id='input" + item.index + "' size='20'>";
        button = row.insertCell(5);
        button.innerHTML = "<button onclick=send_row_data()>Send this</button>";
      } else {
        row.insertCell(4);
        row.insertCell(5);
      }
    }

    function request_all_data() {
      client.publish(publish_topic, '1 1 1 1 2 3 1 ' + registers);
    }
    function request_row_data() {
      let row_id = event.target.parentNode.parentNode.id;
      client.publish(publish_topic, '1 1 1 1 2 3 ' + data_items[row_id].index + ' ' + data_items[row_id].bytes);
      waiting = row_id;
    }
    function send_row_data() {
      let row_id = event.target.parentNode.parentNode.id;
      var value;
      if ( data_items[row_id].type == "bin" ){
        value = parseInt(document.getElementById('input' + data_items[row_id].index ).value.trim(), 2);
        console.log(value);
      } else {
        value = parseInt(document.getElementById('input' + data_items[row_id].index ).value.trim());
      }
      console.log(value);
      if ( isNaN( value )) {
        document.getElementById('input').value = '';
        return
      }
      if ( data_items[row_id].bytes == 1){
        client.publish(publish_topic, '1 1 1 1 2 16 ' + data_items[row_id].index + ' 1 ' + ( value & 0xFFFF ));
      } else if ( data_items[row_id].bytes == 2){
        client.publish(publish_topic, '1 1 1 1 2 16 ' + ( data_items[row_id].index ) + ' 2 ' + ( value & 0xFFFF ) + ',' + ( value >>> 16 ));
      }
    }
    function send_reset( code ) {
      client.publish(publish_topic, '1 1 1 1 2 16 91 1 ' + code );
    }
    function update_row(message, data_items){
      item = data_items[waiting];
      if ( item.bytes == 1){
        var data = message[2];
        document.getElementById(waiting).cells[1].innerHTML = data;
        if ( item.type == "bin" ){ data = (data >>> 0).toString(2); } // Bit shift right to force unsigned int
      } else if ( item.bytes == 2 ){
        var data = ( message[3] << 16 ) | message[2];
        if ( item.type == "time" ){ data = new Date(data*1000).toISOString(); }
        document.getElementById(waiting).cells[1].innerHTML = data;
      }
      waiting = -1
    }

    function update_table(message, data_items){
      for (let i = 0; i < data_items.length; i++) {
        item = data_items[i];
        if ( item.bytes == 1){
          var data = message[item.index + 1];
          document.getElementById("data_table").rows[i+1].cells[1].innerHTML = data;
        } else if ( item.bytes == 2 ){
          var data = ( message[item.index + 2] << 16 ) | message[item.index + 1];
          if ( item.type == "time" ){ data = new Date(data*1000).toISOString(); }
          document.getElementById("data_table").rows[i+1].cells[1].innerHTML = data;
        }
      }
    }
  </script>
</body>
</html>
